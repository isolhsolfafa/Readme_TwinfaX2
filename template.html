<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>$title$</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
    <!-- Mermaid CSS -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        .markdown-body {
            box-sizing: border-box;
            min-width: 200px;
            max-width: 980px;
            margin: 0 auto;
            padding: 45px;
        }
        @media (max-width: 767px) {
            .markdown-body {
                padding: 15px;
            }
        }
        /* 추가 커스텀 스타일 */
        .markdown-body h1 {
            border-bottom: 3px solid #4285f4;
            padding-bottom: 10px;
        }
        .markdown-body img[alt*="badge"] {
            margin: 2px;
        }
        /* Mermaid 다이어그램 스타일 */
        .mermaid {
            text-align: center;
            margin: 20px 0;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            padding: 20px;
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <article class="markdown-body">
        $body$
    </article>
    
    <!-- Mermaid 초기화 스크립트 -->
    <script>
        console.log('Mermaid script loading...');
        
        // Mermaid 초기화
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            securityLevel: 'loose'
        });

        function findAndConvertMermaid() {
            console.log('Looking for Mermaid diagrams...');
            
            // 모든 텍스트 노드와 코드 블록 검사
            const walker = document.createTreeWalker(
                document.body,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );

            const textNodes = [];
            let node;
            while (node = walker.nextNode()) {
                textNodes.push(node);
            }

            // 코드 블록도 별도로 검사
            const codeElements = document.querySelectorAll('code, pre');
            
            console.log(`Found ${textNodes.length} text nodes and ${codeElements.length} code elements`);

            let converted = 0;

            // 텍스트 노드에서 Mermaid 찾기
            textNodes.forEach(textNode => {
                const text = textNode.textContent.trim();
                if (text.startsWith('graph ') || 
                    text.startsWith('pie ') || 
                    text.startsWith('flowchart ') ||
                    text.startsWith('subgraph ')) {
                    
                    console.log('Found Mermaid in text node:', text.substring(0, 30));
                    
                    const mermaidDiv = document.createElement('div');
                    mermaidDiv.className = 'mermaid';
                    mermaidDiv.textContent = text;
                    
                    textNode.parentNode.replaceChild(mermaidDiv, textNode);
                    converted++;
                }
            });

            // 코드 요소에서 Mermaid 찾기
            codeElements.forEach(codeElement => {
                const text = codeElement.textContent.trim();
                if (text.startsWith('graph ') || 
                    text.startsWith('pie ') || 
                    text.startsWith('flowchart ') ||
                    text.startsWith('subgraph ')) {
                    
                    console.log('Found Mermaid in code element:', text.substring(0, 30));
                    
                    const mermaidDiv = document.createElement('div');
                    mermaidDiv.className = 'mermaid';
                    mermaidDiv.textContent = text;
                    
                    // pre 태그 안의 code라면 pre를 교체
                    if (codeElement.parentElement && codeElement.parentElement.tagName === 'PRE') {
                        codeElement.parentElement.parentNode.replaceChild(mermaidDiv, codeElement.parentElement);
                    } else {
                        codeElement.parentNode.replaceChild(mermaidDiv, codeElement);
                    }
                    converted++;
                }
            });

            console.log(`Converted ${converted} Mermaid diagrams`);

            if (converted > 0) {
                // Mermaid 렌더링
                mermaid.run().then(() => {
                    console.log('✅ Mermaid rendering completed successfully!');
                }).catch(err => {
                    console.error('❌ Mermaid rendering failed:', err);
                });
            } else {
                console.log('ℹ️ No Mermaid diagrams found to convert');
            }
        }

        // 여러 시점에서 실행하여 확실히 처리
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', findAndConvertMermaid);
        } else {
            findAndConvertMermaid();
        }

        window.addEventListener('load', () => {
            setTimeout(findAndConvertMermaid, 500);
        });

        // 마지막 안전장치
        setTimeout(findAndConvertMermaid, 1000);
    </script>
</body>
</html>
